<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Bot Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Bot Game</h1>
            <p>Write Python code to guide your bot to the finish line!</p>
        </header>

        <div class="level-selector">
            <div class="level-info">
                <h2 id="level-title">Level 1: Loading...</h2>
                <p id="level-description">Loading level...</p>
                <div class="level-meta">
                    <span id="level-difficulty" class="badge">Easy</span>
                    <span id="level-size" class="badge">5x5</span>
                </div>
            </div>
            <div class="level-controls">
                <button id="prev-level" class="btn btn-nav">‚óÄ Previous</button>
                <select id="level-select" class="level-dropdown"></select>
                <button id="next-level" class="btn btn-nav">Next ‚ñ∂</button>
            </div>
        </div>

        <div class="game-area">
            <div class="grid-container">
                <h3>Game Grid</h3>
                <div id="grid-display" class="grid-display">
                    Loading grid...
                </div>
                <div class="game-info">
                    <div id="bot-status">Bot Status: Ready</div>
                    <div id="command-count">Commands Used: 0</div>
                    <div id="max-commands">Max Commands: 3</div>
                </div>
            </div>

            <div class="code-area">
                <h3>Your Python Code</h3>
                <textarea id="code-input" placeholder="Write your bot code here...

Example:
while True:
    if bot.can_move():
        bot.move_forward()
    else:
        bot.turn_right()">while True:
    if bot.can_move():
        bot.move_forward()
    else:
        bot.turn_right()</textarea>
                
                <div class="controls">
                    <label for="delay-slider">Animation Speed:</label>
                    <input type="range" id="delay-slider" min="0" max="2" step="0.1" value="0.5">
                    <span id="delay-value">0.5s</span>
                </div>
                
                <div class="button-group">
                    <button id="run-code" class="btn btn-primary">üöÄ Run Code</button>
                    <button id="reset-grid" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="output-area">
                    <h4>Output</h4>
                    <div id="output">Ready to execute code...</div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>How to Play</h3>
            <ul>
                <li><strong>bot.move_forward()</strong> - Move the bot forward in its current direction</li>
                <li><strong>bot.turn_left()</strong> - Turn the bot left (counterclockwise)</li>
                <li><strong>bot.turn_right()</strong> - Turn the bot right (clockwise)</li>
                <li><strong>bot.can_move()</strong> - Check if the bot can move forward (returns True/False)</li>
            </ul>
            <p><strong>Goal:</strong> Get your bot (ü§ñ) to reach the finish line (üü´) using as few commands as possible!</p>
            <p><strong>Legend:</strong> ‚¨ú Empty, ‚¨õ Wall, üü¶ Special wall, üü´ Finish line</p>
            <p><strong>Bot Directions:</strong> ‚¨ÜÔ∏è Up, ‚¨ÖÔ∏è Left, ‚¨áÔ∏è Down, ‚û°Ô∏è Right</p>
        </div>
    </div>

    <script>
        // Bot Game JavaScript
        let isLoading = false;
        let currentLevel = 1;
        let allLevels = [];

        // Load initial grid
        document.addEventListener('DOMContentLoaded', function() {
            loadLevels();
            setupDelaySlider();
        });

        function setupDelaySlider() {
            const slider = document.getElementById('delay-slider');
            const value = document.getElementById('delay-value');
            
            slider.addEventListener('input', function() {
                value.textContent = this.value + 's';
            });
        }

        async function loadLevels() {
            try {
                const response = await fetch('/levels');
                const data = await response.json();
                allLevels = data.levels;
                
                // Populate level dropdown
                const dropdown = document.getElementById('level-select');
                dropdown.innerHTML = '';
                allLevels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.number;
                    option.textContent = `Level ${level.number}: ${level.name}`;
                    dropdown.appendChild(option);
                });
                
                // Load the first level
                loadGrid(1);
            } catch (error) {
                addOutput('Error loading levels: ' + error.message, 'error');
            }
        }

        async function loadGrid(levelNumber = null) {
            if (levelNumber !== null) {
                currentLevel = levelNumber;
            }
            
            try {
                const response = await fetch(`/grid?level=${currentLevel}`);
                const data = await response.json();
                
                if (data.error) {
                    addOutput('Error: ' + data.error, 'error');
                    return;
                }
                
                // Update grid display
                document.getElementById('grid-display').textContent = data.grid_state;
                document.getElementById('max-commands').textContent = `Par: ${data.max_commands} commands`;
                
                // Update level info
                const levelInfo = data.level_info;
                document.getElementById('level-title').textContent = `Level ${levelInfo.number}: ${levelInfo.name}`;
                document.getElementById('level-description').textContent = levelInfo.description;
                document.getElementById('level-difficulty').textContent = levelInfo.difficulty;
                document.getElementById('level-difficulty').className = `badge difficulty-${levelInfo.difficulty.toLowerCase()}`;
                document.getElementById('level-size').textContent = levelInfo.size;
                
                // Update dropdown
                document.getElementById('level-select').value = currentLevel;
                
                // Update navigation buttons
                document.getElementById('prev-level').disabled = currentLevel === 1;
                document.getElementById('next-level').disabled = currentLevel === allLevels.length;
                
            } catch (error) {
                addOutput('Error loading grid: ' + error.message, 'error');
            }
        }

        async function playAnimation(frames, delay) {
            /**
             * Play frames sequentially with delay between each frame
             */
            for (let i = 0; i < frames.length; i++) {
                const frame = frames[i];
                
                // Update grid display
                document.getElementById('grid-display').textContent = frame.grid_state;
                
                // Show current action
                if (i > 0) {  // Skip initial state
                    addOutput(`${i}. ${frame.action}`);
                }
                
                // Update bot status during animation
                if (frame.win_state) {
                    document.getElementById('bot-status').textContent = 'Bot Status: üèÜ VICTORY!';
                    document.getElementById('bot-status').className = 'success';
                } else if (!frame.alive) {
                    document.getElementById('bot-status').textContent = 'Bot Status: üíÄ DEAD';
                    document.getElementById('bot-status').className = 'error';
                } else {
                    document.getElementById('bot-status').textContent = 'Bot Status: üèÉ RUNNING';
                    document.getElementById('bot-status').className = '';
                }
                
                // Wait for the delay before showing next frame (but always show the last frame)
                if (i < frames.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * 1000));
                } else {
                    // Ensure final frame is visible for at least a moment
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // Return the final frame for status updates
            return frames[frames.length - 1];
        }

        async function executeCode() {
            if (isLoading) return;
            
            isLoading = true;
            const runButton = document.getElementById('run-code');
            const code = document.getElementById('code-input').value;
            const delay = parseFloat(document.getElementById('delay-slider').value);
            
            if (!code.trim()) {
                addOutput('Please enter some code to execute', 'error');
                isLoading = false;
                return;
            }

            runButton.disabled = true;
            runButton.textContent = '‚è≥ Running...';
            clearOutput();
            addOutput(`Executing code with ${delay}s delay between frames...`);

            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code,
                        level: currentLevel
                    })
                });

                const result = await response.json();

                if (result.success || result.frames) {
                    let finalFrame = null;
                    
                    // Animate through all frames
                    if (result.frames && result.frames.length > 0) {
                        finalFrame = await playAnimation(result.frames, delay);
                    } else {
                        // Fallback: just show final state
                        document.getElementById('grid-display').textContent = result.grid_state;
                    }
                    
                    // Show final results
                    addOutput('‚îÄ'.repeat(40));
                    addOutput(result.message, result.success ? 'success' : 'error');
                    addOutput(`Total commands used: ${result.command_count}`);
                    
                    // Update final status based on result (takes precedence over frame data)
                    document.getElementById('command-count').textContent = `Commands Used: ${result.command_count}`;
                    
                    // Ensure the final grid state is displayed
                    if (result.grid_state) {
                        document.getElementById('grid-display').textContent = result.grid_state;
                    }
                    
                    // Update status - use result data which is authoritative
                    if (result.win_state) {
                        document.getElementById('bot-status').textContent = 'Bot Status: üèÜ VICTORY!';
                        document.getElementById('bot-status').className = 'success';
                    } else if (!result.alive) {
                        document.getElementById('bot-status').textContent = 'Bot Status: üíÄ DEAD';
                        document.getElementById('bot-status').className = 'error';
                    } else {
                        document.getElementById('bot-status').textContent = 'Bot Status: ‚úÖ COMPLETED';
                        document.getElementById('bot-status').className = '';
                    }
                } else {
                    addOutput('‚ùå ' + result.error, 'error');
                    document.getElementById('bot-status').textContent = 'Bot Status: ‚ùå ERROR';
                    document.getElementById('bot-status').className = 'error';
                }

            } catch (error) {
                addOutput('Network error: ' + error.message, 'error');
                document.getElementById('bot-status').textContent = 'Bot Status: ‚ùå CONNECTION ERROR';
                document.getElementById('bot-status').className = 'error';
            }

            runButton.disabled = false;
            runButton.textContent = 'üöÄ Run Code';
            isLoading = false;
        }

        function resetGrid() {
            document.getElementById('bot-status').textContent = 'Bot Status: Ready';
            document.getElementById('bot-status').className = '';
            document.getElementById('command-count').textContent = 'Commands Used: 0';
            document.getElementById('command-count').className = '';
            loadGrid();
            clearOutput();
            addOutput('Grid reset to starting position');
        }

        function addOutput(message, type = 'normal') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Event listeners
        document.getElementById('run-code').addEventListener('click', executeCode);
        document.getElementById('reset-grid').addEventListener('click', resetGrid);
        
        // Level navigation
        document.getElementById('prev-level').addEventListener('click', function() {
            if (currentLevel > 1) {
                loadGrid(currentLevel - 1);
                clearOutput();
                addOutput(`Loaded Level ${currentLevel}`);
            }
        });
        
        document.getElementById('next-level').addEventListener('click', function() {
            if (currentLevel < allLevels.length) {
                loadGrid(currentLevel + 1);
                clearOutput();
                addOutput(`Loaded Level ${currentLevel}`);
            }
        });
        
        document.getElementById('level-select').addEventListener('change', function() {
            loadGrid(parseInt(this.value));
            clearOutput();
            addOutput(`Loaded Level ${currentLevel}`);
        });

        // Keyboard shortcut
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executeCode();
            }
        });
    </script>
</body>
</html>

